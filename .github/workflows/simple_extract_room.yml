name: Extract and Notify via Telegram Bot

on:
  repository_dispatch:
    types: [extract_from_bot]

jobs:
  extract-and-notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Extract Room Info from Script
      id: extract
      run: |
        # client_payloadì—ì„œ ë§¤ë¬¼ë²ˆí˜¸ë¥¼ ê°€ì ¸ì™€ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        ARTICLE_NO="${{ github.event.client_payload.article_no }}"
        echo "Extracting info for article: $ARTICLE_NO"
        
        # ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ "RESULT_JSON" í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥
        RESULT_JSON=$(python extract_room_cli.py "$ARTICLE_NO" --json)
        echo "RESULT_JSON<<EOF" >> $GITHUB_ENV
        echo "$RESULT_JSON" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Send Result via Telegram
      uses: actions/github-script@v7
      with:
        script: |
          const result = JSON.parse(process.env.RESULT_JSON);
          const chatId = ${{ github.event.client_payload.chat_id }};
          const botToken = "${{ secrets.TELEGRAM_BOT_TOKEN }}"; # GitHub Secretsì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°

          let message = '';
          if (result.success) {
            message += `ğŸ  **ë™í˜¸ìˆ˜ ì¶”ì¶œ ê²°ê³¼**\n\n`;
            message += `âœ… **ì„±ê³µ!**\n`;
            message += `> **ë§¤ë¬¼ë²ˆí˜¸**: ${result.article_no || 'N/A'}\n`;
            message += `> **ë‹¨ì§€ëª…**: ${result.complex_name || 'ì •ë³´ì—†ìŒ'}\n`;
            message += `> **ê°€ê²©**: ${result.price || 'ì •ë³´ì—†ìŒ'}\n`;
            message += `> **ë™**: ${result.dong || 'ì •ë³´ì—†ìŒ'}\n`;
            message += `> **í˜¸ìˆ˜**: ${result.ho || 'ì •ë³´ì—†ìŒ'}\n`;
            message += `> **ì „ì²´ì£¼ì†Œ**: ${result.full_address || 'ì •ë³´ì—†ìŒ'}\n`;
          } else {
            message += `âŒ **ì¶”ì¶œ ì‹¤íŒ¨**\n\n`;
            message += `> **ì˜¤ë¥˜**: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`;
          }

          const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
          const payload = {
            chat_id: chatId,
            text: message,
            parse_mode: 'Markdown'
          };

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const responseData = await response.json();
          if (!response.ok) {
            console.error('Failed to send message:', responseData);
            throw new Error(`Telegram API request failed with status ${response.status}`);
          }
          
          console.log('Successfully sent message to Telegram.');
